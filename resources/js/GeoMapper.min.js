!function(e){Craft.GeoMapper=Garnish.Base.extend({handle:null,$container:null,$mapsContainer:null,$fieldTab:null,$inputFields:null,$buttonField:null,$latField:null,$lngField:null,googleMaps:null,googleMarker:null,googleGeo:new google.maps.Geocoder,createdMap:!1,skipFirstUpdate:!1,seperatedAddress:!1,init:function(t){this.handle=t.handle,this.seperatedAddress=t.seperatedAddress,this.$container=e(".geo-mapper-field."+this.handle),this.$mapsContainer=e(".geo-mapper-maps",this.$container),this.$fieldTab=this.$container.closest(".field").parent(),this.$inputFields=this.$container.find("input:not(.geo-mapper-ignore)"),this.$buttonField=this.$container.find('input[name*="updateCoords"]'),this.$latField=this.$container.find('input[name*="lat"]'),this.$lngField=this.$container.find('input[name*="lng"]'),this.addListener(this.$buttonField,"click","getCoords"),this.addListener(e(".tabs .tab"),"click","switchElementTab"),("tab1"==this.$fieldTab.attr("id")||void 0==this.$fieldTab.attr("id"))&&this.initSavedCoords()},initSavedCoords:function(){var e=this.$latField.val(),t=this.$lngField.val();if(""!=e&&""!=t){var a=new google.maps.LatLng(e,t);this.skipFirstUpdate=!0,this.createMap(this,a)}},getCoords:function(t){var a={},i=this,n=!1;if(e.each(this.$inputFields,function(t,o){var s=e(o).attr("id").replace("fields-"+i.handle+"-","");a[s]=e(o).val(),""!=a[s]&&(n=!0)}),n){var o=i.seperatedAddress?a.street+" "+a.housenumber:a.address;o+=a.zip?", "+a.zip:"",o+=a.city?", "+a.city:"",o+=a.country?", "+a.country:"",this.getGeoLocation(o,this.updateMap)}t.preventDefault()},createMap:function(e,t){this.createdMap||(this.createdMap=!0,e.$mapsContainer.removeClass("hidden"),e.$mapsContainer.fadeIn(400,function(){e.googleMaps=new google.maps.Map(e.$mapsContainer[0],{zoom:1,scrollwheel:!1,center:t,streetViewControl:!1}),e.updateMap(e,t)}))},updateMap:function(e,t){return e.$mapsContainer.hasClass("hidden")?void e.createMap(e,t):(null===e.googleMarker?(e.googleMarker=new google.maps.Marker({map:e.googleMaps,draggable:!0,animation:google.maps.Animation.DROP,position:t}),google.maps.event.addListener(e.googleMarker,"dragend",function(t){e.updateCoordFields(e,t,!0)})):e.googleMarker.setPosition(t),e.googleMaps.setCenter(t),e.googleMaps.getZoom()<15&&e.googleMaps.setZoom(15),void e.updateCoordFields(e,t,!1))},updateCoordFields:function(e,t,a){e.skipFirstUpdate?e.skipFirstUpdate=!1:a?(e.$latField.val(t.latLng.lat()),e.$lngField.val(t.latLng.lng())):(e.$latField.val(t.lat()),e.$lngField.val(t.lng()))},getGeoLocation:function(e,t){var a=this,i=null;this.googleGeo.geocode({address:e},function(e,n){n==google.maps.GeocoderStatus.OK&&(i=e[0].geometry.location,t(a,i))})},switchElementTab:function(t){if(!this.createdMap){var a=e(t.currentTarget).attr("href").replace("#",""),i=e("#"+a);i.attr("id")==this.$fieldTab.attr("id")&&this.initSavedCoords()}}})}(jQuery);