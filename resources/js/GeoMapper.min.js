!function(e){Craft.GeoMapper=Garnish.Base.extend({handle:null,$container:null,$mapsContainer:null,$fieldTab:null,$inputFields:null,$buttonField:null,$latField:null,$lngField:null,googleMaps:null,googleMarker:null,googleGeo:new google.maps.Geocoder,createdMap:!1,skipFirstUpdate:!1,seperatedAddress:!1,init:function(t){this.handle=t.handle,this.seperatedAddress=t.seperatedAddress,this.$container=e("#"+this.handle),this.$mapsContainer=e(".geo-mapper-maps",this.$container),this.$fieldTab=this.$container.closest(".field").parent(),this.$inputFields=this.$container.find("input:not(.geo-mapper-ignore)"),this.$buttonField=this.$container.find('input[name*="updateCoords"]'),this.$latField=this.$container.find('input[name*="lat"]'),this.$lngField=this.$container.find('input[name*="lng"]'),this.addListener(this.$buttonField,"click","getCoords"),this.addListener(e(".tabs .tab"),"click","switchElementTab"),("tab1"==this.$fieldTab.attr("id")||void 0==this.$fieldTab.attr("id"))&&this.initSavedCoords()},initSavedCoords:function(){var e=this.$latField.val(),t=this.$lngField.val();if(""!=e&&""!=t){var i=new google.maps.LatLng(e,t);this.skipFirstUpdate=!0,this.createMap(this,i)}},getCoords:function(t){var i={},a=this,n=!1;if(e.each(this.$inputFields,function(t,a){var o=e(a).attr("id").substring(e(a).attr("id").lastIndexOf("-")).substring(1);i[o]=e(a).val(),""!=i[o]&&(n=!0)}),n){var o=a.seperatedAddress?i.street+" "+i.housenumber:i.address;o+=i.zip?", "+i.zip:"",o+=i.city?", "+i.city:"",o+=i.country?", "+i.country:"",this.getGeoLocation(o,this.updateMap)}t.preventDefault()},createMap:function(e,t){this.createdMap||(this.createdMap=!0,e.$mapsContainer.removeClass("hidden"),e.$mapsContainer.fadeIn(400,function(){e.googleMaps=new google.maps.Map(e.$mapsContainer[0],{zoom:1,scrollwheel:!1,center:t,streetViewControl:!1}),e.updateMap(e,t)}))},updateMap:function(e,t){return e.$mapsContainer.hasClass("hidden")?void e.createMap(e,t):(null===e.googleMarker?(e.googleMarker=new google.maps.Marker({map:e.googleMaps,draggable:!0,animation:google.maps.Animation.DROP,position:t}),google.maps.event.addListener(e.googleMarker,"dragend",function(t){e.updateCoordFields(e,t,!0)})):e.googleMarker.setPosition(t),e.googleMaps.setCenter(t),e.googleMaps.getZoom()<15&&e.googleMaps.setZoom(15),void e.updateCoordFields(e,t,!1))},updateCoordFields:function(e,t,i){e.skipFirstUpdate?e.skipFirstUpdate=!1:i?(e.$latField.val(t.latLng.lat()),e.$lngField.val(t.latLng.lng())):(e.$latField.val(t.lat()),e.$lngField.val(t.lng()))},getGeoLocation:function(e,t){var i=this,a=null;this.googleGeo.geocode({address:e},function(e,n){n==google.maps.GeocoderStatus.OK&&(a=e[0].geometry.location,t(i,a))})},switchElementTab:function(t){if(!this.createdMap){var i=e(t.currentTarget).attr("href").replace("#",""),a=e("#"+i);a.attr("id")==this.$fieldTab.attr("id")&&this.initSavedCoords()}}})}(jQuery);
